name: Deploy Nginx

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - id: 'auth'
      uses: 'google-github-actions/auth@v2'
      with:
        project_id: 'my-project'
        workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider'

    - id: 'get-credentials'
      uses: 'google-github-actions/get-gke-credentials@v2'
      with:
        cluster_name: 'my-cluster'
        location: 'us-central1-a'

    # The KUBECONFIG env var is automatically exported and picked up by kubectl.
    - id: 'get-pods'
      run: 'kubectl get pods'

    # - name: build and push the docker image
    #   env:
    #     GOOGLE_PROJECT: ${{ secrets.GKE_PROJECT }}
    #   run: |
    #     gcloud auth configure-docker us-central1-docker.pkg.dev
    #     docker build -t us-central1-docker.pkg.dev/$GOOGLE_PROJECT/demo/nginx:latest .
    #     docker push us-central1-docker.pkg.dev/$GOOGLE_PROJECT/demo/nginx:latest

    # - name: deploy to gke
    #   env:
    #     GOOGLE_PROJECT: ${{ secrets.GKE_PROJECT }}
    #   run: |
    #     gcloud container clusters get-credentials autopilot-cluster-1 --region us-central1
    #     sed -i "s/GOOGLE_PROJECT/$GOOGLE_PROJECT/g" resources.yaml
    #     kubectl apply -f resources.yaml
